#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

# hack: will only work on OBS-created chroots
SOURCESDIRS=/usr/src/packages/SOURCES/ ~/

# decide on hard- and soft-float
ifeq (armhf, $(shell dpkg-architecture -qDEB_HOST_ARCH))
  FLOATOPT=hard
else
  FLOATOPT=soft
endif

# skip opencl on distros where glibc or gcc are too old
DISTOPTS=
DHINSTOPTS=
ifneq (, $(filter $(shell lsb_release --codename --short), wheezy))
  DISTOPTS += --skip-cl
  DHINSTOPTS += -XlibCLC.so -XlibOpenCL.so -XlibVivanteOpenCL.so -Xcl11 -XCL
endif

%:
	dh $@ --parallel

override_dh_auto_clean:
	for file in *.pc; do if [ -e "$$file" ]; then rm -fv "$$file"; fi; done
	rm -vf *.so.*
	find . -type d -iname "imx-gpu-viv-*-*" -exec rm -rf {} \; || true
	rm -vf *.bin
build: 
	# create dummy libraries for directfb and wayland; dpkg-shlibdeps will complain otherwise
	gcc -shared -Wl,-soname,libdirectfb-1.7.so.4 -o libdirectfb-1.7.so.4
	gcc -shared -Wl,-soname,libdirect-1.7.so.4 -o libdirect-1.7.so.4
	gcc -shared -Wl,-soname,libwayland-server.so.0 -o libwayland-server.so.0
	gcc -shared -Wl,-soname,libwayland-client.so.0 -o libwayland-client.so.0
	gcc -shared -Wl,-soname,libffi.so.6 -o libffi.so.6

	# create dummies for the backend-dependent libs required by the indep package;
	# dpkg-shlibdeps will otherwise add one backend package as dependency to all of them
	gcc -shared -Wl,-soname,libEGL.so.1 -o libEGL.so.1
	gcc -shared -Wl,-soname,libGLESv2.so.2 -o libGLESv2.so.2
	gcc -shared -Wl,-soname,libGAL.so -o libGAL.so
	gcc -shared -Wl,-soname,libVIVANTE.so -o libVIVANTE.so

	# create fake libwayland-egl.so.1
	#gcc -shared -Wl,-soname,libwayland-egl.so.1 -o libwayland-egl.so.1

override_dh_auto_install:
	find $(SOURCESDIRS) -maxdepth 1 -iname "imx-gpu-viv-*-sfp.bin" -exec cp -v {} ./ \; || true
	find $(SOURCESDIRS) -maxdepth 1 -iname "imx-gpu-viv-*-hfp.bin" -exec cp -v {} ./ \; || true
	./install.sh --destdir $(CURDIR)/debian/tmp --skip-alternatives --dridir /usr/lib/dri --fhw $(FLOATOPT) $(DISTOPTS)
	#install -v -m644 libwayland-egl.so.1 $(CURDIR)/debian/tmp/usr/lib/
	install -v -m644 -D vivante.profile.sh $(CURDIR)/debian/tmp/etc/profile.d/vivante.sh
	mkdir -p $(CURDIR)/debian/tmp/etc/ld.so.conf.d
	echo "/usr/lib/galcore" > $(CURDIR)/debian/tmp/etc/ld.so.conf.d/0vivante.conf

override_dh_install:
	dh_install --fail-missing $(DHINSTOPTS)

override_dh_shlibdeps:
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore -pimx-gpu-viv -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore:$(CURDIR)/debian/imx-gpu-viv-fb/usr/lib/galcore -pimx-gpu-viv-fb -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore:$(CURDIR)/debian/imx-gpu-viv-dfb/usr/lib/galcore -pimx-gpu-viv-dfb -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore:$(CURDIR)/debian/imx-gpu-viv-wl/usr/lib/galcore -pimx-gpu-viv-wl -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore:$(CURDIR)/debian/imx-gpu-viv-x11/usr/lib/galcore -pimx-gpu-viv-x11 -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -l$(CURDIR):$(CURDIR)/debian/imx-gpu-viv/usr/lib/galcore -pimx-gpu-viv-demos -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -plibg2d0.8 -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11
	dh_shlibdeps -plibg2d-demos -- -ximx-gpu-viv-fb -ximx-gpu-viv-dfb -ximx-gpu-viv-wl -ximx-gpu-viv-x11

override_dh_strip:
	dh_strip --package=imx-gpu-viv --dbg-package=imx-gpu-viv-dbg
	dh_strip --package=imx-gpu-viv-fb --dbg-package=imx-gpu-viv-fb-dbg
	dh_strip --package=imx-gpu-viv-dfb --dbg-package=imx-gpu-viv-dfb-dbg
	dh_strip --package=imx-gpu-viv-x11 --dbg-package=imx-gpu-viv-x11-dbg
	dh_strip --package=imx-gpu-viv-wl --dbg-package=imx-gpu-viv-wl-dbg
	dh_strip --package=libg2d0.8 --dbg-package=libg2d0.8-dbg
